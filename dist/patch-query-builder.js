"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.patchSelectQueryBuilder = void 0;

var _typeorm = require("typeorm");

const GET_QUERY_COPY = "___scope_getQuery_copy___";

class SelectQB extends _typeorm.SelectQueryBuilder {
  getQuery() {
    this.___patchScopes___();

    return this[GET_QUERY_COPY]();
  }

  ___patchScopes___() {
    for (const table of this.expressionMap.aliases) {
      if (!table || !table.hasMetadata) continue;
      const metadata = table.metadata.tableMetadataArgs;

      if (metadata.scopes && metadata.scopesEnabled) {
        for (const scope of metadata.scopes) scope(this, table.name);
      } else if (metadata.scopesEnabled === false) {
        metadata.scopesEnabled = true;
      }
    }
  }

}

class UpdateQB extends _typeorm.UpdateQueryBuilder {
  getQuery() {
    this.___patchScopes___();

    return this[GET_QUERY_COPY]();
  }

  ___patchScopes___() {
    for (const table of this.expressionMap.aliases) {
      if (!table || !table.hasMetadata) continue;
      const metadata = table.metadata.tableMetadataArgs;

      if (metadata.scopes && metadata.scopesEnabled) {
        for (const scope of metadata.scopes) scope(this, table.name);
      } else if (metadata.scopesEnabled === false) {
        metadata.scopesEnabled = true;
      }
    }
  }

}

class DeleteQB extends _typeorm.DeleteQueryBuilder {
  getQuery() {
    this.___patchScopes___();

    return this[GET_QUERY_COPY]();
  }

  ___patchScopes___() {
    for (const table of this.expressionMap.aliases) {
      if (!table || !table.hasMetadata) continue;
      const metadata = table.metadata.tableMetadataArgs;

      if (metadata.scopes && metadata.scopesEnabled) {
        for (const scope of metadata.scopes) scope(this, table.name);
      } else if (metadata.scopesEnabled === false) {
        metadata.scopesEnabled = true;
      }
    }
  }

}

const patchSelectQueryBuilder = () => {
  _typeorm.SelectQueryBuilder.prototype[GET_QUERY_COPY] = _typeorm.SelectQueryBuilder.prototype.getQuery;

  for (const property of Object.getOwnPropertyNames(SelectQB.prototype)) {
    Object.defineProperty(_typeorm.SelectQueryBuilder.prototype, property, Object.getOwnPropertyDescriptor(SelectQB.prototype, property));
  }

  _typeorm.UpdateQueryBuilder.prototype[GET_QUERY_COPY] = _typeorm.UpdateQueryBuilder.prototype.getQuery;

  for (const property of Object.getOwnPropertyNames(UpdateQB.prototype)) {
    Object.defineProperty(_typeorm.UpdateQueryBuilder.prototype, property, Object.getOwnPropertyDescriptor(UpdateQB.prototype, property));
  }

  _typeorm.DeleteQueryBuilder.prototype[GET_QUERY_COPY] = _typeorm.DeleteQueryBuilder.prototype.getQuery;

  for (const property of Object.getOwnPropertyNames(DeleteQB.prototype)) {
    Object.defineProperty(_typeorm.DeleteQueryBuilder.prototype, property, Object.getOwnPropertyDescriptor(DeleteQB.prototype, property));
  }
};

exports.patchSelectQueryBuilder = patchSelectQueryBuilder;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wYXRjaC1xdWVyeS1idWlsZGVyLnRzIl0sIm5hbWVzIjpbIkdFVF9RVUVSWV9DT1BZIiwiU2VsZWN0UUIiLCJTZWxlY3RRdWVyeUJ1aWxkZXIiLCJnZXRRdWVyeSIsIl9fX3BhdGNoU2NvcGVzX19fIiwidGFibGUiLCJleHByZXNzaW9uTWFwIiwiYWxpYXNlcyIsImhhc01ldGFkYXRhIiwibWV0YWRhdGEiLCJ0YWJsZU1ldGFkYXRhQXJncyIsInNjb3BlcyIsInNjb3Blc0VuYWJsZWQiLCJzY29wZSIsIm5hbWUiLCJVcGRhdGVRQiIsIlVwZGF0ZVF1ZXJ5QnVpbGRlciIsIkRlbGV0ZVFCIiwiRGVsZXRlUXVlcnlCdWlsZGVyIiwicGF0Y2hTZWxlY3RRdWVyeUJ1aWxkZXIiLCJwcm90b3R5cGUiLCJwcm9wZXJ0eSIsIk9iamVjdCIsImdldE93blByb3BlcnR5TmFtZXMiLCJkZWZpbmVQcm9wZXJ0eSIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUdBLE1BQU1BLGNBQWMsR0FBRywyQkFBdkI7O0FBRUEsTUFBTUMsUUFBTixTQUFxREMsMkJBQXJELENBQWdGO0FBQy9FQyxFQUFBQSxRQUFRLEdBQVc7QUFDbEIsU0FBS0MsaUJBQUw7O0FBQ0EsV0FBTyxLQUFLSixjQUFMLEdBQVA7QUFDQTs7QUFFU0ksRUFBQUEsaUJBQWlCLEdBQVM7QUFDbkMsU0FBSyxNQUFNQyxLQUFYLElBQW9CLEtBQUtDLGFBQUwsQ0FBbUJDLE9BQXZDLEVBQWdEO0FBQy9DLFVBQUksQ0FBQ0YsS0FBRCxJQUFVLENBQUNBLEtBQUssQ0FBQ0csV0FBckIsRUFBa0M7QUFDbEMsWUFBTUMsUUFBUSxHQUFHSixLQUFLLENBQUNJLFFBQU4sQ0FBZUMsaUJBQWhDOztBQUNBLFVBQUlELFFBQVEsQ0FBQ0UsTUFBVCxJQUFtQkYsUUFBUSxDQUFDRyxhQUFoQyxFQUErQztBQUM5QyxhQUFLLE1BQU1DLEtBQVgsSUFBb0JKLFFBQVEs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cEMsQ0FBdkIsRUFBdUU7QUFDdEVFLElBQUFBLE1BQU0sQ0FBQ0UsY0FBUCxDQUFzQlIsNEJBQW1CSSxTQUF6QyxFQUFvREMsUUFBcEQsRUFBOERDLE1BQU0sQ0FBQ0csd0JBQVAsQ0FBZ0NWLFFBQVEsQ0FBQ0ssU0FBekMsRUFBb0RDLFFBQXBELENBQTlEO0FBQ0E7O0FBRURILDhCQUFtQkUsU0FBbkIsQ0FBNkJwQixjQUE3QixJQUErQ2tCLDRCQUFtQkUsU0FBbkIsQ0FBNkJqQixRQUE1RTs7QUFDQSxPQUFLLE1BQU1rQixRQUFYLElBQXVCQyxNQUFNLENBQUNDLG1CQUFQLENBQTJCTixRQUFRLENBQUNHLFNBQXBDLENBQXZCLEVBQXVFO0FBQ3RFRSxJQUFBQSxNQUFNLENBQUNFLGNBQVAsQ0FBc0JOLDRCQUFtQkUsU0FBekMsRUFBb0RDLFFBQXBELEVBQThEQyxNQUFNLENBQUNHLHdCQUFQLENBQWdDUixRQUFRLENBQUNHLFNBQXpDLEVBQW9EQyxRQUFwRCxDQUE5RDtBQUNBO0FBQ0QsQ0FmTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERlbGV0ZVF1ZXJ5QnVpbGRlciwgT2JqZWN0TGl0ZXJhbCwgU2VsZWN0UXVlcnlCdWlsZGVyLCBVcGRhdGVRdWVyeUJ1aWxkZXIgfSBmcm9tIFwidHlwZW9ybVwiXG5pbXBvcnQgeyBTY29wZWRUYWJsZU1ldGFkYXRhIH0gZnJvbSBcIi4vdGFibGUtbWV0YWRhdGFcIlxuXG5jb25zdCBHRVRfUVVFUllfQ09QWSA9IFwiX19fc2NvcGVfZ2V0UXVlcnlfY29weV9fX1wiXG5cbmNsYXNzIFNlbGVjdFFCPEVudGl0eSBleHRlbmRzIE9iamVjdExpdGVyYWw+IGV4dGVuZHMgU2VsZWN0UXVlcnlCdWlsZGVyPEVudGl0eT4ge1xuXHRnZXRRdWVyeSgpOiBzdHJpbmcge1xuXHRcdHRoaXMuX19fcGF0Y2hTY29wZXNfX18oKVxuXHRcdHJldHVybiB0aGlzW0dFVF9RVUVSWV9DT1BZXSgpXG5cdH1cblxuXHRwcm90ZWN0ZWQgX19fcGF0Y2hTY29wZXNfX18oKTogdm9pZCB7XG5cdFx0Zm9yIChjb25zdCB0YWJsZSBvZiB0aGlzLmV4cHJlc3Npb25NYXAuYWxpYXNlcykge1xuXHRcdFx0aWYgKCF0YWJsZSB8fCAhdGFibGUuaGFzTWV0YWRhdGEpIGNvbnRpbnVlXG5cdFx0XHRjb25zdCBtZXRhZGF0YSA9IHRhYmxlLm1ldGFkYXRhLnRhYmxlTWV0YWRhdGFBcmdzIGFzIFNjb3BlZFRhYmxlTWV0YWRhdGE8RW50aXR5PlxuXHRcdFx0aWYgKG1ldGFkYXRhLnNjb3BlcyAmJiBtZXRhZGF0YS5zY29wZXNFbmFibGVkKSB7XG5cdFx0XHRcdGZvciAoY29uc3Qgc2NvcGUgb2YgbWV0YWRhdGEuc2NvcGVzKSBzY29wZSh0aGlzLCB0YWJsZS5uYW1lKVxuXHRcdFx0fSBlbHNlIGlmIChtZXRhZGF0YS5zY29wZXNFbmFibGVkID09PSBmYWxzZSkge1xuXHRcdFx0XHRtZXRhZGF0YS5zY29wZXNFbmFibGVkID0gdHJ1ZVxuXHRcdFx0fVxuXHRcdH1cblx0fVxufVxuXG5jbGFzcyBVcGRhdGVRQjxFbnRpdHkgZXh0ZW5kcyBPYmplY3RMaXRlcmFsPiBleHRlbmRzIFVwZGF0ZVF1ZXJ5QnVpbGRlcjxFbnRpdHk+IHtcblx0Z2V0UXVlcnkoKTogc3RyaW5nIHtcblx0XHR0aGlzLl9fX3BhdGNoU2NvcGVzX19fKClcblx0XHRyZXR1cm4gdGhpc1tHRVRfUVVFUllfQ09QWV0oKVxuXHR9XG5cblx0cHJvdGVjdGVkIF9fX3BhdGNoU2NvcGVzX19fKCk6IHZvaWQge1xuXHRcdGZvciAoY29uc3QgdGFibGUgb2YgdGhpcy5leHByZXNzaW9uTWFwLmFsaWFzZXMpIHtcblx0XHRcdGlmICghdGFibGUgfHwgIXRhYmxlLmhhc01ldGFkYXRhKSBjb250aW51ZVxuXHRcdFx0Y29uc3QgbWV0YWRhdGEgPSB0YWJsZS5tZXRhZGF0YS50YWJsZU1ldGFkYXRhQXJncyBhcyBTY29wZWRUYWJsZU1ldGFkYXRhPEVudGl0eT5cblx0XHRcdGlmIChtZXRhZGF0YS5zY29wZXMgJiYgbWV0YWRhdGEuc2NvcGVzRW5hYmxlZCkge1xuXHRcdFx0XHRmb3IgKGNvbnN0IHNjb3BlIG9mIG1ldGFkYXRhLnNjb3Blcykgc2NvcGUodGhpcywgdGFibGUubmFtZSlcblx0XHRcdH0gZWxzZSBpZiAobWV0YWRhdGEuc2NvcGVzRW5hYmxlZCA9PT0gZmFsc2UpIHtcblx0XHRcdFx0bWV0YWRhdGEuc2NvcGVzRW5hYmxlZCA9IHRydWVcblx0XHRcdH1cblx0XHR9XG5cdH1cbn1cblxuY2xhc3MgRGVsZXRlUUI8RW50aXR5IGV4dGVuZHMgT2JqZWN0TGl0ZXJhbD4gZXh0ZW5kcyBEZWxldGVRdWVyeUJ1aWxkZXI8RW50aXR5PiB7XG5cdGdldFF1ZXJ5KCk6IHN0cmluZyB7XG5cdFx0dGhpcy5fX19wYXRjaFNjb3Blc19fXygpXG5cdFx0cmV0dXJuIHRoaXNbR0VUX1FVRVJZX0NPUFldKClcblx0fVxuXG5cdHByb3RlY3RlZCBfX19wYXRjaFNjb3Blc19fXygpOiB2b2lkIHtcblx0XHRmb3IgKGNvbnN0IHRhYmxlIG9mIHRoaXMuZXhwcmVzc2lvbk1hcC5hbGlhc2VzKSB7XG5cdFx0XHRpZiAoIXRhYmxlIHx8ICF0YWJsZS5oYXNNZXRhZGF0YSkgY29udGludWVcblx0XHRcdGNvbnN0IG1ldGFkYXRhID0gdGFibGUubWV0YWRhdGEudGFibGVNZXRhZGF0YUFyZ3MgYXMgU2NvcGVkVGFibGVNZXRhZGF0YTxFbnRpdHk+XG5cdFx0XHRpZiAobWV0YWRhdGEuc2NvcGVzICYmIG1ldGFkYXRhLnNjb3Blc0VuYWJsZWQpIHtcblx0XHRcdFx0Zm9yIChjb25zdCBzY29wZSBvZiBtZXRhZGF0YS5zY29wZXMpIHNjb3BlKHRoaXMsIHRhYmxlLm5hbWUpXG5cdFx0XHR9IGVsc2UgaWYgKG1ldGFkYXRhLnNjb3Blc0VuYWJsZWQgPT09IGZhbHNlKSB7XG5cdFx0XHRcdG1ldGFkYXRhLnNjb3Blc0VuYWJsZWQgPSB0cnVlXG5cdFx0XHR9XG5cdFx0fVxuXHR9XG59XG5cbmV4cG9ydCBjb25zdCBwYXRjaFNlbGVjdFF1ZXJ5QnVpbGRlciA9ICgpID0+IHtcblx0U2VsZWN0UXVlcnlCdWlsZGVyLnByb3RvdHlwZVtHRVRfUVVFUllfQ09QWV0gPSBTZWxlY3RRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmdldFF1ZXJ5XG5cdGZvciAoY29uc3QgcHJvcGVydHkgb2YgT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoU2VsZWN0UUIucHJvdG90eXBlKSkge1xuXHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTZWxlY3RRdWVyeUJ1aWxkZXIucHJvdG90eXBlLCBwcm9wZXJ0eSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihTZWxlY3RRQi5wcm90b3R5cGUsIHByb3BlcnR5KSBhcyBQcm9wZXJ0eURlc2NyaXB0b3IpXG5cdH1cblxuXHRVcGRhdGVRdWVyeUJ1aWxkZXIucHJvdG90eXBlW0dFVF9RVUVSWV9DT1BZXSA9IFVwZGF0ZVF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuZ2V0UXVlcnlcblx0Zm9yIChjb25zdCBwcm9wZXJ0eSBvZiBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhVcGRhdGVRQi5wcm90b3R5cGUpKSB7XG5cdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KFVwZGF0ZVF1ZXJ5QnVpbGRlci5wcm90b3R5cGUsIHByb3BlcnR5LCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKFVwZGF0ZVFCLnByb3RvdHlwZSwgcHJvcGVydHkpIGFzIFByb3BlcnR5RGVzY3JpcHRvcilcblx0fVxuXG5cdERlbGV0ZVF1ZXJ5QnVpbGRlci5wcm90b3R5cGVbR0VUX1FVRVJZX0NPUFldID0gRGVsZXRlUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5nZXRRdWVyeVxuXHRmb3IgKGNvbnN0IHByb3BlcnR5IG9mIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKERlbGV0ZVFCLnByb3RvdHlwZSkpIHtcblx0XHRPYmplY3QuZGVmaW5lUHJvcGVydHkoRGVsZXRlUXVlcnlCdWlsZGVyLnByb3RvdHlwZSwgcHJvcGVydHksIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoRGVsZXRlUUIucHJvdG90eXBlLCBwcm9wZXJ0eSkgYXMgUHJvcGVydHlEZXNjcmlwdG9yKVxuXHR9XG59XG4iXX0=